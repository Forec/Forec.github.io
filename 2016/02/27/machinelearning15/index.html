<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>机器学习笔记（Chapter 15 - MapReduce框架） | Forec&#39;s Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="Algorithms,机器学习" />
    
    <meta name="description" content="MapReduce是一个分布式计算框架，可以将单个计算作业分配给多台计算机执行。">
<meta property="og:type" content="article">
<meta property="og:title" content="机器学习笔记（Chapter 15 - MapReduce框架）">
<meta property="og:url" content="http://forec.github.io/2016/02/27/machinelearning15/index.html">
<meta property="og:site_name" content="Forec's Notes">
<meta property="og:description" content="MapReduce是一个分布式计算框架，可以将单个计算作业分配给多台计算机执行。">
<meta property="og:image" content="http://7xktmz.com1.z0.glb.clouddn.com/machine-learning-12.png">
<meta property="og:updated_time" content="2016-11-04T16:17:23.704Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="机器学习笔记（Chapter 15 - MapReduce框架）">
<meta name="twitter:description" content="MapReduce是一个分布式计算框架，可以将单个计算作业分配给多台计算机执行。">
    

    
        <link rel="alternate" href="/atom.xml" title="Forec&#39;s Notes" type="application/atom+xml" />
    

    
        <link rel="icon" href="http://7xktmz.com1.z0.glb.clouddn.com/sitefavicon.png# path to favicon" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css" type="text/css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css" type="text/css">

    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <script src="/libs/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css" type="text/css">
    
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">关于我</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/columns/index.html">专栏</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/projects/index.html">个人项目列表</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="http://forec.cn">FOREC 的官方网站</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/apis/index.html">API</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js" type="text/javascript"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/大数据/">大数据</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-machinelearning15" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        机器学习笔记（Chapter 15 - MapReduce框架）
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                <a href="/2016/02/27/machinelearning15/" class="article-date">
    <time datetime="2016-02-27T06:32:18.000Z" itemprop="datePublished">2016-02-27</time>
</a>
                
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Algorithms/">Algorithms</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/机器学习/">机器学习</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <blockquote>
<p>MapReduce是一个分布式计算框架，可以将单个计算作业分配给多台计算机执行。</p>
</blockquote>
<a id="more"></a>
<h1 id="MapReduce工作流程"><a href="#MapReduce工作流程" class="headerlink" title="MapReduce工作流程"></a>MapReduce工作流程</h1><ul>
<li>MapReduce框架的优点是可以短时间内完成大量工作，缺点是算法必须经过重写，需要对系统工程有一定理解。适用于数值型和标称型数据。</li>
<li>MapReduce工作流程是：单个作业被分成很多小份，输入数据被切片分发到每个节点，各个节点只在本地数据上做运算，对应的运算代码称为mapper，该过程称为map阶段。每个mapper的输出通过某种方式组合（一般还会做排序），排序后的结果再被分成小份分发给各个节点进行下一步处理。第二步处理阶段称为reduce，对应运行代码称为reducer。reducer的输出为程序最终执行结果。</li>
<li>在任何时候，每个mapper或reducer之间都不进行通信。每个节点值处理自己的事务，且在本地分配的数据集上计算。</li>
<li>主节点控制MapReduce的作业流程，数据被重复存放在不同的机器上防止某个机器失效。mapper和reducer传输的数据形式为key/value对。</li>
</ul>
<h1 id="MapReduce上的机器学习"><a href="#MapReduce上的机器学习" class="headerlink" title="MapReduce上的机器学习"></a>MapReduce上的机器学习</h1><ul>
<li>简单贝叶斯：直接使用reducer将各个mapper的结果相加</li>
<li>k-近邻算法：构建树存储数据，利用树形结构缩小搜索范围，该方法在特征数小于10的情况下效果很好。高维数据下（文本、图像、视频）的近邻查找方法是局部敏感哈希算法。</li>
<li>支持向量机：SMO算法构造的SVM无法在MapReduce框架实现，但Pegasos算法构造的SVM和“最邻近支持向量机”更快并且易于在MapReduce框架下实现。</li>
<li>奇异值分解：Lanczos算法是一个有效的求近似特征值的算法，可以应用在MapReduce上从而有效找到大数据的奇异值。该算法还可以应用于PCA。</li>
<li>K-均值聚类：canopy聚类是一个流行的分布式聚类方法，可以先调用canopy聚类法取得最初的k个簇，再运行K-均值聚类算法。</li>
</ul>
<h1 id="在Python中使用mrjob自动化MapReduce"><a href="#在Python中使用mrjob自动化MapReduce" class="headerlink" title="在Python中使用mrjob自动化MapReduce"></a>在Python中使用mrjob自动化MapReduce</h1><ul>
<li><a href="http://packages.python.org/mrjob/" target="_blank" rel="external">mrjob</a>之前是Yelp的内部框架，2010年底开源。可以用于在Amazon网络服务上启动MapReduce<br>作业。可以通过pip安装，也可以clone <a href="https://github.com/Yelp/mrjob" target="_blank" rel="external">GitHub上的源码</a>来安装。在AWS上使用mrjob之前需要设置<code>AWS_ACCESS_KEY_ID</code>和<code>AWS_SECRET_ACCESS_KEY</code>两个环境变量。</li>
<li>使用mrjob可以在EMR上运行Hadoop流，也可以在单机上测试。单机测试的命令为<code>% python mrMean.py &lt; inputFile.txt &gt; myOut.txt</code>，在EMR上运行同样任务的命令为<code>% python mrMean.py -r emr &lt; inputFile.txt &gt; myOut.txt</code>。所有上传和表单填写由mrjob自动完成。</li>
<li>添加下面代码到mrMean.py，创建一个新的MRJob继承类，代码中的mapper和reducer都是该类的方法。steps方法定义了执行的步骤，在该方法中需要为mrjob制定mapper和reducer的名称，未指出则默认调用mapper和reducer。将原来代码中的<code>mr</code>方法修改为<code>mrjob.step.MRStep</code>。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">from mrjob.job import MRJob</span><br><span class="line">import mrjob</span><br><span class="line"></span><br><span class="line">class MRmean(MRJob):</span><br><span class="line">    def __init__(self, *args, **kwargs):</span><br><span class="line">        super(MRmean, self).__init__(*args, **kwargs)</span><br><span class="line">        self.inCount = 0</span><br><span class="line">        self.inSum = 0</span><br><span class="line">        self.inSqSum = 0</span><br><span class="line">    def map(self, key, val):</span><br><span class="line">        if False:</span><br><span class="line">            yield</span><br><span class="line">        inVal = float(val)</span><br><span class="line">        self.inCount += 1</span><br><span class="line">        self.inSum += inVal</span><br><span class="line">        self.inSqSum += inVal*inVal</span><br><span class="line">    def map_final(self):</span><br><span class="line">        mn = self.inSum/self.inCount</span><br><span class="line">        mnSq = self.inSqSum/self.inCount</span><br><span class="line">        yield(1, [self.inCount, mn, mnSq])</span><br><span class="line">    def reduce(self, key, packedValues):</span><br><span class="line">        cumVal = 0.0; cumSumSq = 0.0; cumN = 0.0</span><br><span class="line">        for valArr in packedValues:</span><br><span class="line">            nj = float(valArr[0])</span><br><span class="line">            cumN += nj</span><br><span class="line">            cumVal += nj*float(valArr[1])</span><br><span class="line">            cumSumSq += nj*float(valArr[2])</span><br><span class="line">        mean = cumVal/cumN</span><br><span class="line">        var = (cumSumSq - 2*mean*cumVal + cumN*mean*mean)/cumN</span><br><span class="line">        yield(mean, var)</span><br><span class="line">    def steps(self):</span><br><span class="line">        return ([mrjob.step.MRStep(mapper=self.map, reducer=self.reduce,\</span><br><span class="line">            mapper_final=self.map_final)])</span><br><span class="line"></span><br><span class="line">if __name__ == '__main__':</span><br><span class="line">    MRmean.run()</span><br><span class="line"></span><br><span class="line">$ python mrMean.py --mapper &lt; inputFile.txt</span><br><span class="line">1       [100, 0.5095697, 0.34443931307936]</span><br><span class="line"></span><br><span class="line">$ python mrMean.py &lt; inputFile.txt</span><br><span class="line">reading from STDIN</span><br><span class="line">writing to %\mrMean.Forec.20160227.045814.965000\step-0-mapper_part-00000</span><br><span class="line">Counters from step 1:</span><br><span class="line">  (no counters found)</span><br><span class="line">writing to %\mrMean.Forec.20160227.045814.965000\step-0-mapper-sorted</span><br><span class="line">&gt; sort '%\mrMean.Forec.20160227.045814.965000\step-0-mapper_part-00000'</span><br><span class="line">writing to %\mrMean.Forec.20160227.045814.965000\step-0-reducer_part-00000</span><br><span class="line">Counters from step 1:</span><br><span class="line">  (no counters found)</span><br><span class="line">Moving %\mrMean.Forec.20160227.045814.965000\step-0-reducer_part-00000\</span><br><span class="line"> -&gt; %\mrMean.Forec.20160227.045814.965000\output\part-00000</span><br><span class="line">Streaming final output from %\mrMean.Forec.20160227.045814.965000\output</span><br><span class="line">0.5095697       0.08477803392126998</span><br><span class="line">removing tmp directory %\mrMean.Forec.20160227.045814.965000</span><br></pre></td></tr></table></figure>
<h1 id="分布式SVM的Pegasos算法"><a href="#分布式SVM的Pegasos算法" class="headerlink" title="分布式SVM的Pegasos算法"></a>分布式SVM的Pegasos算法</h1><h2 id="Pegasos算法"><a href="#Pegasos算法" class="headerlink" title="Pegasos算法"></a>Pegasos算法</h2><ul>
<li>SMO算法的一个替代品是Pegasos算法，后者可以很容易写成MapReduce形式。Pegasos是指原始估计梯度求解器（Primal Estimated sub-GrAdient Solver）。该算法使用某种形式的随机梯度下降方法来解决SVM所定义的优化问题，该算法所需的迭代次数取决于用户所期望的精确度而不是数据集的大小。其工作流程是：从训练集中随机挑选一些样本点添加到待处理列表中，之后按序判断每个样本点是否能被分类正确；如果是则忽略，否则将其加入待更新集合。批处理完毕后，权重向量按照这些错分的样本进行更新。伪代码为：<ul>
<li>将W初始化为0</li>
<li>对每次批处理</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;随机选择k个样本点（向量）</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;对每个向量</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果该向量被错分</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;更新权重向量W</li>
<li>&nbsp;&nbsp;&nbsp;&nbsp;累加对W的更新</li>
</ul>
</li>
<li>代码为Pegasos算法的串行版本，输入值T和k分别设定了迭代次数和待处理列表的大小。在T次迭代过程中，每次需要重新计算eta。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predict</span><span class="params">(w, x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> w*x.T</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">batchPegasos</span><span class="params">(dataSet, labels, lam, T, k)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    m, n = shape(dataSet); w = zeros(n)</span><br><span class="line">    dataIndex = range(m)</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">1</span>, T+<span class="number">1</span>):</span><br><span class="line">        wDelta = mat(zeros(n))</span><br><span class="line">        eta = <span class="number">1.0</span>/(lam*t)</span><br><span class="line">        random.shuffle(dataIndex)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(k):</span><br><span class="line">            i = dataIndex[j]</span><br><span class="line">            p = predict(w, dataSet[i,:])</span><br><span class="line">            <span class="keyword">if</span> labels[i]*p &lt; <span class="number">1</span>:</span><br><span class="line">                wDelta += labels[i]*dataSet[i,:].A</span><br><span class="line">        w = (<span class="number">1.0</span> - <span class="number">1</span>/t)*w + (eta/k)*wDelta</span><br><span class="line">    <span class="keyword">return</span> w</span><br></pre></td></tr></table></figure>
<h2 id="mrjob实现MapReduce版本的SVM"><a href="#mrjob实现MapReduce版本的SVM" class="headerlink" title="mrjob实现MapReduce版本的SVM"></a>mrjob实现MapReduce版本的SVM</h2><ul>
<li>Pegasos算法有大量的内积计算，内积计算可以并行。<code>Cinfigure_options</code>方法建立了一些变量，包括迭代次数T，待处理列表大小k。steps方法告诉mrjob应该做什么，按照什么顺序做。其创建了一个python列表，包含<code>map</code>、<code>map_fin</code>和<code>reduce</code>几个步骤，最后将该列表乘以迭代次数，即在每次迭代中重复调用这个列表。mapper需要能够正确读取reducer输出的数据，对输入和输出格式作如下规定：Mapper输入为<code>&lt;mapperNum, valueList&gt;</code>，无输出；<code>Mapper_final</code>无输入，输出为<code>&lt;l, valueList&gt;</code>；Reducer的输入输出均为<code>&lt;mapperNum, valueList&gt;</code>。传入的值是列表数组，valueList第一个元素是一个字符串，表示列表后面存放的数据类型，每个<code>Mapper_final</code>都将输出同样的key以保证所有的key/value都输出给同一个reducer。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mrjob.job <span class="keyword">import</span> MRJob</span><br><span class="line"><span class="keyword">import</span> mrjob</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MRsvm</span><span class="params">(MRJob)</span>:</span></span><br><span class="line">    DEFAULT_INPUT_PROTOCOL = <span class="string">'json_value'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        super(MRsvm, self).__init__(*args, **kwargs)</span><br><span class="line">        self.data = pickle.load(open(<span class="string">'%\\svmDat27'</span>))</span><br><span class="line">        self.w = <span class="number">0</span></span><br><span class="line">        self.eta = <span class="number">0.69</span></span><br><span class="line">        self.dataList = []</span><br><span class="line">        self.k = self.options.batchsize</span><br><span class="line">        self.numMappers = <span class="number">1</span></span><br><span class="line">        self.t = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">map</span><span class="params">(self, mapperId, inVals)</span>:</span> <span class="comment">#needs exactly 2 arguments</span></span><br><span class="line">        <span class="comment">#input: nodeId, ('w', w-vector) OR nodeId, ('x', int)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">False</span>: <span class="keyword">yield</span></span><br><span class="line">        <span class="keyword">if</span> inVals[<span class="number">0</span>]==<span class="string">'w'</span>:                  <span class="comment">#accumulate W-vector</span></span><br><span class="line">            self.w = inVals[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">elif</span> inVals[<span class="number">0</span>]==<span class="string">'x'</span>:</span><br><span class="line">            self.dataList.append(inVals[<span class="number">1</span>])<span class="comment">#accumulate data points to calc</span></span><br><span class="line">        <span class="keyword">elif</span> inVals[<span class="number">0</span>]==<span class="string">'t'</span>: self.t = inVals[<span class="number">1</span>] </span><br><span class="line">        <span class="keyword">else</span>: self.eta=inVals <span class="comment">#this is for debug, eta not used in map</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">map_fin</span><span class="params">(self)</span>:</span></span><br><span class="line">        labels = self.data[:,-<span class="number">1</span>]; X=self.data[:,<span class="number">0</span>:-<span class="number">1</span>]<span class="comment">#reshape data into X and Y</span></span><br><span class="line">        <span class="keyword">if</span> self.w == <span class="number">0</span>: self.w = [<span class="number">0.001</span>]*shape(X)[<span class="number">1</span>] <span class="comment">#init w on first iteration</span></span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> self.dataList:</span><br><span class="line">            p = mat(self.w)*X[index,:].T <span class="comment">#calc p=w*dataSet[key].T </span></span><br><span class="line">            <span class="keyword">if</span> labels[index]*p &lt; <span class="number">1.0</span>:</span><br><span class="line">                <span class="keyword">yield</span> (<span class="number">1</span>, [<span class="string">'u'</span>, index])<span class="comment">#make sure everything has the same key</span></span><br><span class="line">        <span class="keyword">yield</span> (<span class="number">1</span>, [<span class="string">'w'</span>, self.w])       <span class="comment">#so it ends up at the same reducer</span></span><br><span class="line">        <span class="keyword">yield</span> (<span class="number">1</span>, [<span class="string">'t'</span>, self.t])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reduce</span><span class="params">(self, _, packedVals)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> valArr <span class="keyword">in</span> packedVals: <span class="comment">#get values from streamed inputs</span></span><br><span class="line">            <span class="keyword">if</span> valArr[<span class="number">0</span>]==<span class="string">'u'</span>:  self.dataList.append(valArr[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">elif</span> valArr[<span class="number">0</span>]==<span class="string">'w'</span>: self.w = valArr[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">elif</span> valArr[<span class="number">0</span>]==<span class="string">'t'</span>:  self.t = valArr[<span class="number">1</span>] </span><br><span class="line">        labels = self.data[:,-<span class="number">1</span>]; X=self.data[:,<span class="number">0</span>:-<span class="number">1</span>]</span><br><span class="line">        wMat = mat(self.w);   wDelta = mat(zeros(len(self.w)))</span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> self.dataList:</span><br><span class="line">            wDelta += float(labels[index])*X[index,:] <span class="comment">#wDelta += label*dataSet</span></span><br><span class="line">        eta = <span class="number">1.0</span>/(<span class="number">2.0</span>*self.t)       <span class="comment">#calc new: eta</span></span><br><span class="line">        <span class="comment">#calc new: w = (1.0 - 1/t)*w + (eta/k)*wDelta</span></span><br><span class="line">        wMat = (<span class="number">1.0</span> - <span class="number">1.0</span>/self.t)*wMat + (eta/self.k)*wDelta</span><br><span class="line">        <span class="keyword">for</span> mapperNum <span class="keyword">in</span> range(<span class="number">1</span>,self.numMappers+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">yield</span> (mapperNum, [<span class="string">'w'</span>, wMat.tolist()[<span class="number">0</span>] ]) <span class="comment">#emit w</span></span><br><span class="line">            <span class="keyword">if</span> self.t &lt; self.options.iterations:</span><br><span class="line">                <span class="keyword">yield</span> (mapperNum, [<span class="string">'t'</span>, self.t+<span class="number">1</span>])<span class="comment">#increment T</span></span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> range(self.k/self.numMappers):<span class="comment">#emit random ints for mappers iid</span></span><br><span class="line">                    <span class="keyword">yield</span> (mapperNum, [<span class="string">'x'</span>, random.randint(shape(self.data)[<span class="number">0</span>]) ])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">configure_options</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(MRsvm, self).configure_options()</span><br><span class="line">        self.add_passthrough_option(<span class="string">'--iterations'</span>, dest=<span class="string">'iterations'</span>, default=<span class="number">2</span>,\</span><br><span class="line">            type = <span class="string">'int'</span>, help=<span class="string">'T: number of iterations to run'</span>)</span><br><span class="line">        self.add_passthrough_option(<span class="string">'--batchsize'</span>, dest=<span class="string">'batchsize'</span>, default=<span class="number">100</span>,\</span><br><span class="line">            type=<span class="string">'int'</span>, help=<span class="string">'k: number of data points in a batch'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">steps</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> ([mrjob.step.MRStep(mapper=self.map, mapper_final=self.map_fin, \</span><br><span class="line">            reducer=self.reduce)]*self.options.iterations)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    MRsvm.run()</span><br></pre></td></tr></table></figure>
<ul>
<li>大多数情况下并不需要使用MapReduce框架，如果作业花费了太多时间，首先应思考能否用更高效的语言编写，或者是否可以优化。寻找影响处理速度的瓶颈才能根本解决效率底下的问题。</li>
</ul>
<h1 id="MapReduce总结"><a href="#MapReduce总结" class="headerlink" title="MapReduce总结"></a>MapReduce总结</h1><blockquote>
<p>当运算需求超出了当前资源的运算能力，可以考虑购买更好的机器，或者租用网络服务并使用MapReduce框架并行执行。很多机器学习算法都可以容易地写成MapReduce作业，而某些需要经过重写。大部分情况下，MapReduce并不需要。</p>
</blockquote>
<hr>
<p>参考文献： 《机器学习实战 - 美Peter Harrington》</p>
<p>原创作品，允许转载，转载时无需告知，但请务必以超链接形式标明文章<a href="https://forec.github.io/2016/02/27/machinelearning15/">原始出处</a>(<a href="https://forec.github.io/2016/02/27/machinelearning15/">https://forec.github.io/2016/02/27/machinelearning15/</a>) 、作者信息（<a href="https://forec.github.io/">Forec</a>）和本声明。</p>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://forec.github.io/2016/02/27/machinelearning15/" data-id="cixrule77004xusewh8wq5yxd" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div class="ds-thread" data-thread-key="2016/02/27/machinelearning15/" data-title="机器学习笔记（Chapter 15 - MapReduce框架）" data-url="http://forec.github.io/2016/02/27/machinelearning15/"></div>
    <style>
        #ds-thread #ds-reset .ds-textarea-wrapper {
            background: none;
        }
        #ds-reset .ds-avatar img {
            box-shadow: none;
        }
        #ds-reset .ds-gradient-bg {
            background: #f7f7f7;
        }
        #ds-thread #ds-reset li.ds-tab a {
            border-radius: 3px;
        }
        #ds-thread #ds-reset .ds-post-button {
            color: white;
            border: none;
            box-shadow: none;
            background: #d32;
            text-shadow: none;
            font-weight: normal;
            font-family: 'Microsoft Yahei';
        }
        #ds-thread #ds-reset .ds-post-button:hover {
            color: white;
            background: #DE594C;
        }
        #ds-thread #ds-reset .ds-post-button:active {
            background: #d32;
        }
        #ds-smilies-tooltip ul.ds-smilies-tabs li a.ds-current {
            color: white;
            background: #d32;
            box-shadow: none;
            text-shadow: none;
            font-weight: normal;
        }
    </style>

    
    </section>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/Forec" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus-circle" href="https://plus.google.com/u/0/103559279723380829001" target="_blank">
                        <i class="icon fa fa-google-plus-circle"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="https://www.facebook.com/MrForec" target="_blank">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="https://twitter.com/MrForec" target="_blank">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/atom.xml" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="mail-forward" href="mailto:forec@bupt.edu.cn" target="_blank">
                        <i class="icon fa fa-mail-forward"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2016/02/27/marhinelearningsummary/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            《机器学习实战》总结
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2016/02/26/machinelearning14/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">机器学习笔记（Chapter 14 - SVD简化）</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/01/08/os-concepts-16/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/os-concepts-16.jpg)" alt="互斥读者-读者问题" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/计算机理论基础/">计算机理论基础</a></p>
                            <p class="item-title"><a href="/2017/01/08/os-concepts-16/" class="title">互斥读者-读者问题</a></p>
                            <p class="item-date"><time datetime="2017-01-08T09:52:59.000Z" itemprop="datePublished">2017-01-08</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/01/08/os-concepts-15/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/os-concepts-15.jpg)" alt="操作系统（专题）：信号量编程（下）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/计算机理论基础/">计算机理论基础</a></p>
                            <p class="item-title"><a href="/2017/01/08/os-concepts-15/" class="title">操作系统（专题）：信号量编程（下）</a></p>
                            <p class="item-date"><time datetime="2017-01-08T03:53:13.000Z" itemprop="datePublished">2017-01-08</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/01/06/os-concetps-14/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/os-concepts-14-r.jpg)" alt="操作系统（专题）：信号量编程（上）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/计算机理论基础/">计算机理论基础</a></p>
                            <p class="item-title"><a href="/2017/01/06/os-concetps-14/" class="title">操作系统（专题）：信号量编程（上）</a></p>
                            <p class="item-date"><time datetime="2017-01-06T09:21:43.000Z" itemprop="datePublished">2017-01-06</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/01/06/os-concepts-13/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/os-concepts-13.jpg)" alt="操作系统（十三）：I/O 输入系统" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/计算机理论基础/">计算机理论基础</a></p>
                            <p class="item-title"><a href="/2017/01/06/os-concepts-13/" class="title">操作系统（十三）：I/O 输入系统</a></p>
                            <p class="item-date"><time datetime="2017-01-06T04:17:33.000Z" itemprop="datePublished">2017-01-06</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/01/05/os-concepts-12/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/os-concepts-12.jpg)" alt="操作系统（十二）：大容量存储器结构" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/计算机理论基础/">计算机理论基础</a></p>
                            <p class="item-title"><a href="/2017/01/05/os-concepts-12/" class="title">操作系统（十二）：大容量存储器结构</a></p>
                            <p class="item-date"><time datetime="2017-01-05T15:23:30.000Z" itemprop="datePublished">2017-01-05</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Code/">Code</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Configuration/">Configuration</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Language/">Language</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机理论基础/">计算机理论基础</a><span class="category-list-count">22</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Access/" style="font-size: 10px;">Access</a> <a href="/tags/Algorithms/" style="font-size: 20px;">Algorithms</a> <a href="/tags/CVM/" style="font-size: 10px;">CVM</a> <a href="/tags/Data-Structures/" style="font-size: 11.82px;">Data-Structures</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Emacs/" style="font-size: 10px;">Emacs</a> <a href="/tags/Golang/" style="font-size: 16.36px;">Golang</a> <a href="/tags/Hadoop/" style="font-size: 10.91px;">Hadoop</a> <a href="/tags/Haskell/" style="font-size: 13.64px;">Haskell</a> <a href="/tags/Mistakes/" style="font-size: 12.73px;">Mistakes</a> <a href="/tags/OS/" style="font-size: 19.09px;">OS</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Qt/" style="font-size: 10px;">Qt</a> <a href="/tags/Raspberry/" style="font-size: 10px;">Raspberry</a> <a href="/tags/Safety/" style="font-size: 10px;">Safety</a> <a href="/tags/Spark/" style="font-size: 10px;">Spark</a> <a href="/tags/sicp/" style="font-size: 10.91px;">sicp</a> <a href="/tags/云存储/" style="font-size: 15.45px;">云存储</a> <a href="/tags/函数式编程/" style="font-size: 14.55px;">函数式编程</a> <a href="/tags/图分割/" style="font-size: 10.91px;">图分割</a> <a href="/tags/字符编码/" style="font-size: 10.91px;">字符编码</a> <a href="/tags/机器学习/" style="font-size: 18.18px;">机器学习</a> <a href="/tags/线程/" style="font-size: 17.27px;">线程</a> <a href="/tags/计组与体系结构/" style="font-size: 13.64px;">计组与体系结构</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://forec.cn">Forec的官方网站</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>京ICP备16060806号-1 &copy; 2017 Forec</p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'forec'};
    (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
    || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>



    
        <script src="/libs/lightgallery/js/lightgallery.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js" type="text/javascript"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js" type="text/javascript"></script>

    </div>
</body>
</html>
