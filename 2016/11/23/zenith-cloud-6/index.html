<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>顶点云（应用）服务器逻辑实现 | Forec&#39;s Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="Golang,云存储,线程" />
    
    <meta name="description" content="分析、设计云存储服务器的执行逻辑，包括用户验证登录、活动连接加入与释放、代理操作等。">
<meta property="og:type" content="article">
<meta property="og:title" content="顶点云（应用）服务器逻辑实现">
<meta property="og:url" content="http://forec.github.io/2016/11/23/zenith-cloud-6/index.html">
<meta property="og:site_name" content="Forec's Notes">
<meta property="og:description" content="分析、设计云存储服务器的执行逻辑，包括用户验证登录、活动连接加入与释放、代理操作等。">
<meta property="og:image" content="http://7xktmz.com1.z0.glb.clouddn.com/zenith-cloud-6.jpg">
<meta property="og:updated_time" content="2016-12-23T17:33:01.791Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="顶点云（应用）服务器逻辑实现">
<meta name="twitter:description" content="分析、设计云存储服务器的执行逻辑，包括用户验证登录、活动连接加入与释放、代理操作等。">
    

    
        <link rel="alternate" href="/atom.xml" title="Forec&#39;s Notes" type="application/atom+xml" />
    

    
        <link rel="icon" href="http://7xktmz.com1.z0.glb.clouddn.com/sitefavicon.png# path to favicon" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css" type="text/css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css" type="text/css">

    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <script src="/libs/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css" type="text/css">
    
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">关于我</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/columns/index.html">专栏</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/projects/index.html">个人项目列表</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="http://forec.cn">FOREC 的官方网站</a>
                                </li>
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/apis/index.html">API</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js" type="text/javascript"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Code/">Code</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-zenith-cloud-6" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        顶点云（应用）服务器逻辑实现
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                <a href="/2016/11/23/zenith-cloud-6/" class="article-date">
    <time datetime="2016-11-23T10:42:08.000Z" itemprop="datePublished">2016-11-23</time>
</a>
                
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/">Golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/云存储/">云存储</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/线程/">线程</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <blockquote>
<p>分析、设计云存储服务器的执行逻辑，包括用户验证登录、活动连接加入与释放、代理操作等。</p>
</blockquote>
<a id="more"></a>
<h2 id="服务器结构分析"><a href="#服务器结构分析" class="headerlink" title="服务器结构分析"></a>服务器结构分析</h2><ul>
<li>服务器可按初始化、监听、fork 出线程处理用户请求并继续监听流程处理。在对用户请求新建分支处理时，按照此前 <a href="http://blog.forec.cn/2016/11/13/zenith-cloud-1/" target="_blank" rel="external">认证、传输协议设计</a> 设计的登录、传输线程接入流程处理。</li>
<li>服务器应当维护一个主要的监听器，一个已登录用户列表以及对数据库操作的接口，其数据结构如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">    listener      net.Listener</span><br><span class="line">    loginUserList []cs.User</span><br><span class="line">    db            *sql.DB</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>服务器应当封装如下方法：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (s *Server) InitDB() <span class="typename">bool</span>   <span class="comment">// 初始化数据库</span></span><br><span class="line"><span class="keyword">func</span> (s *Server) BroadCastToAll(message <span class="typename">string</span>)   <span class="comment">// 向全体用户广播消息</span></span><br><span class="line"><span class="keyword">func</span> (s *Server) BroadCast(u cs.User, message <span class="typename">string</span>) <span class="typename">bool</span>   <span class="comment">// 向指定用户发送消息</span></span><br><span class="line"><span class="keyword">func</span> (s *Server) CheckBroadCast()      <span class="comment">// 用户间通信检查（负责用户之间的短时延通讯）</span></span><br><span class="line"><span class="keyword">func</span> (s *Server) AddUser(u cs.User)    <span class="comment">// 向在线列表添加用户</span></span><br><span class="line"><span class="keyword">func</span> (s *Server) RemoveUser(u cs.User) <span class="typename">bool</span>   <span class="comment">// 从在线列表删除用户</span></span><br><span class="line"><span class="keyword">func</span> (s *Server) Login(t trans.Transmitable) (cs.User, <span class="typename">int</span>)    <span class="comment">// 授权用户登录</span></span><br><span class="line"><span class="keyword">func</span> (s *Server) Communicate(conn net.Conn, level <span class="typename">uint8</span>)       <span class="comment">// 处理一个接入的未授权请求</span></span><br><span class="line"><span class="keyword">func</span> (s *Server) Run(ip <span class="typename">string</span>, port <span class="typename">int</span>, level <span class="typename">int</span>)           <span class="comment">// 监听指定地址并运行</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在工程目录下新建 <code>server</code> 目录，要编写的模块名为 <code>server</code>。在该目录下创建文件 <code>server.go</code>， 以下代码均在该文件中编辑。</li>
<li>我们的代码中使用到的包通过如下代码导入：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    auth <span class="string">"zenith-cloud/authenticate"</span></span><br><span class="line">    conf <span class="string">"zenith-cloud/config"</span></span><br><span class="line">    cs <span class="string">"zenith-cloud/cstruct"</span></span><br><span class="line">    trans <span class="string">"zenith-cloud/transmit"</span></span><br><span class="line">    <span class="string">"database/sql"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    _ <span class="string">"github.com/mattn/go-sqlite3"</span></span><br><span class="line">    <span class="string">"net"</span></span><br><span class="line">    <span class="string">"strings"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><ul>
<li>根据 <a href="http://blog.forec.cn/2016/11/12/zenith-cloud-0/" target="_blank" rel="external">此前对数据库的设计</a>，我们需要在程序运行过程中维护五个表记录，在程序运行前应当对数据库和对应表的存在加以检查。</li>
<li>按照设计的数据库表实现的 <code>InitDB()</code> 代码如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (s *Server) InitDB() <span class="typename">bool</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    s.db, err = sql.Open(conf.DATABASE_TYPE, conf.DATABASE_PATH)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    s.db.Exec(<span class="string">`create table cuser (uid INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">        username VARCHAR(64), password VARCHAR(128), created DATE)`</span>)</span><br><span class="line">    s.db.Exec(<span class="string">`create table ufile (uid INTEGER PRIMARY KEY AUTOINCREMENT, </span><br><span class="line">        ownerid INTEGER, cfileid INTEGER, path VARCHAR(256), perlink VARCHAR(128), </span><br><span class="line">        created DATE, shared INTEGER, downloaded INTEGER, filename VARCHAR(128),</span><br><span class="line">        private BOOLEAN, linkpass VARCHAR(4)), isdir BOOLEAN`</span>)</span><br><span class="line">    s.db.Exec(<span class="string">`create table cfile (uid INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">        md5 VARCHAR(32), size INTEGER, ref INTEGER, created DATE)`</span>)</span><br><span class="line">    s.db.Exec(<span class="string">`create table cmessages (mesid INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">        targetid INTEGER, sendid INTEGER, message VARCHAR(512), created DATE)`</span>)</span><br><span class="line">    s.db.Exec(<span class="string">`crete table coperations (oprid INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">        deletedUFileId INTEGER, deletedUFileName VARCHAR(128), </span><br><span class="line">        deletedUFilePath VARCHAR(256), relatedCFileId INTEGER, time DATE)`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="constant">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序将先检查数据库是否存在，不存在则自动创建（<code>sql.Open</code> 函数会在数据库不存在时自动创建新数据库），之后不管表记录是否存在均新建表（若已存在则不会覆盖）。</li>
</ul>
<h2 id="消息广播"><a href="#消息广播" class="headerlink" title="消息广播"></a>消息广播</h2><ul>
<li>消息广播通过每个用户客户端设置的被动监听连接传输</li>
<li>系统向所有用户广播，只需对所有在线用户均调用 <code>BroadCast()</code>，具体实现如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (s *Server) BroadCast(u cs.User, message <span class="typename">string</span>) <span class="typename">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> u.GetInfos() == <span class="constant">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> u.GetInfos().SendBytes([]<span class="typename">byte</span>(message))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> (s *Server) BroadCastToAll(message <span class="typename">string</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> _, u := <span class="keyword">range</span> s.loginUserList &#123;</span><br><span class="line">        s.BroadCast(u, message)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>用户之间的通讯需要服务器作为中转。然而，服务器将用户逻辑处理交予 <code>cuser</code> 结构代理，我们希望用户 <code>cuser</code> 结构和服务器 <code>server</code> 结构尽可能避免耦合，因此用户不应当在自己的 <code>dealWithRequests()</code> 逻辑中调用服务器的 <code>BroadCast()</code> 方法；另外，用户不应该具有判断另一用户是否在线的权限，因此即使用户具有与 <code>BroadCast()</code> 类似的方法，它也无法判断是否该立刻将待发送的消息投放给接收方。</li>
<li>这里采取一个 naive 但是有效的方法：用户发送 <code>send</code> 指令通讯时，要发送的消息会被存储到 <code>cmessage</code> 表中，我们在服务器中启动一个守护线程，监视 <code>cmessage</code> 表，并在固定时间频率时刻检查该表是否有待发送消息，如果有则将可发送的（接收方用户在线）部分消息投放给接收方，并从 <code>cmessage</code> 表中删除投放成功的消息。我们的检查频率会比较快（如几秒一次），用户之间通讯的延迟将在可忍受范围内，毕竟我们要实现的是云存储系统而非即时通讯系统。用户结构和服务器结构保持了分离，用户也没有具有不该有的权限。</li>
<li>用于处理用户间通讯交互的方法是 <code>CheckBroadCast()</code>，其具体实现如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (s *Server) CheckBroadCast() &#123;</span><br><span class="line">    chRate := time.Tick(conf.CHECK_MESSAGE_SEPERATE * time.Second)</span><br><span class="line">    <span class="keyword">var</span> queryRows *sql.Rows</span><br><span class="line">    <span class="keyword">var</span> queryRow *sql.Row</span><br><span class="line">    <span class="keyword">var</span> mesid, uid, messageCount <span class="typename">int</span></span><br><span class="line">    <span class="keyword">var</span> message, created <span class="typename">string</span></span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        &lt;-chRate</span><br><span class="line">        <span class="keyword">for</span> _, u := <span class="keyword">range</span> s.loginUserList &#123;</span><br><span class="line">            queryRow = s.db.QueryRow(fmt.Sprintf(<span class="string">`select count (*) from cmessages where</span><br><span class="line">                targetid=%d`</span>, u.GetId()))</span><br><span class="line">            <span class="keyword">if</span> queryRow == <span class="constant">nil</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            err = queryRow.Scan(&amp;messageCount)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            id_list := <span class="built_in">make</span>([]<span class="typename">int</span>, <span class="number">0</span>, messageCount)</span><br><span class="line">            queryRows, err = s.db.Query(fmt.Sprintf(<span class="string">`select mesid, sendid, message, created</span><br><span class="line">                 from cmessages where targetid=%d`</span>, u.GetId()))</span><br><span class="line">            <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">                fmt.Println(<span class="string">"query error: "</span>, err.Error())</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> queryRows.Next() &#123;</span><br><span class="line">                err = queryRows.Scan(&amp;mesid, &amp;uid, &amp;message, &amp;created)</span><br><span class="line">                <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">                    fmt.Println(<span class="string">"scan error: "</span>, err.Error())</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> s.BroadCast(u, fmt.Sprintf(<span class="string">"%d%s%s%s%s"</span>, uid, conf.SEPERATER, message,</span><br><span class="line">                    conf.SEPERATER, created)) &#123;</span><br><span class="line">                    id_list = <span class="built_in">append</span>(id_list, mesid)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> _, id := <span class="keyword">range</span> id_list &#123;</span><br><span class="line">                _, err = s.db.Exec(fmt.Sprintf(<span class="string">`delete from cmessages where mesid=%d`</span>, id))</span><br><span class="line">                <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">                    fmt.Println(<span class="string">"delete error: "</span>, err.Error())</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><ul>
<li>我们将从上向下分析服务器的运行逻辑</li>
<li>服务器应当对指定端口监听并能够对介入请求创建一个新协程处理：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (s *Server) Run(ip <span class="typename">string</span>, port <span class="typename">int</span>, level <span class="typename">int</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> !trans.IsIpValid(ip) || !trans.IsPortValid(port) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    s.listener, err = net.Listen(<span class="string">"tcp"</span>, fmt.Sprintf(<span class="string">"%s:%d"</span>, ip, port))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"test server starting with an error, break down..."</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> s.listener.Close()</span><br><span class="line">    s.loginUserList = <span class="built_in">make</span>([]cs.User, <span class="number">0</span>, conf.START_USER_LIST)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        sconn, err := s.listener.Accept()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"Error accepting"</span>, err.Error())</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(<span class="string">"Rececive connection request from"</span>,</span><br><span class="line">            sconn.RemoteAddr().String())</span><br><span class="line">        <span class="keyword">go</span> s.Communicate(sconn, <span class="typename">uint8</span>(level))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在运行开始时，还应当对在线用户列表做初始化，并将服务器放置在 <code>for</code> 循环中无线监听。当有请求接入，服务器创建一个新的协程来处理请求。传给协程的参数是对应的连接和安全等级。</li>
</ul>
<h2 id="处理未授权请求"><a href="#处理未授权请求" class="headerlink" title="处理未授权请求"></a>处理未授权请求</h2><ul>
<li><code>Communicate</code> 函数用于处理接入服务器但未经授权的请求。服务器要和对方做一定交互以确定远端身份，不合法时要即时断开腾出资源，多次不合法时也要采取防范攻击的措施。鉴于我们设计的云存储仅仅是练习，并不会投入生产中，因此暂不考虑诸如 SYN 洪水攻击等 DDOS 可能性。在后面我会展示 DDOS 攻击对我设计的云存储系统带来的打击。</li>
<li><code>Communicate</code> 函数接受与远端的连接以及安全等级。它将按照此前设计的协议与远端交互：<ul>
<li>生成一个随机 token，发送给客户端</li>
<li>客户端使用此 token 和服务器做一系列交互，并确定是否合法（login 函数）</li>
<li>返回授权结果</li>
</ul>
</li>
<li><code>Communicate</code> 函数的 Go 语言实现如下：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (s *Server) Communicate(conn net.Conn, level <span class="typename">uint8</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    s_token := auth.GenerateToken(level)</span><br><span class="line">    length, err := conn.Write([]<span class="typename">byte</span>(s_token))</span><br><span class="line">    fmt.Println(<span class="string">"send toekn"</span>, <span class="typename">string</span>(s_token))</span><br><span class="line">    <span class="keyword">if</span> length != conf.TOKEN_LENGTH(level) ||</span><br><span class="line">        err != <span class="constant">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    mainT := trans.NewTransmitter(conn, conf.AUTHEN_BUFSIZE, s_token)</span><br><span class="line">    rc, mode := s.Login(mainT)</span><br><span class="line">    <span class="keyword">if</span> rc == <span class="constant">nil</span> || mode == -<span class="number">1</span> &#123;</span><br><span class="line">        mainT.Destroy()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> !mainT.SendBytes(s_token) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> mode == <span class="number">0</span> &#123;</span><br><span class="line">        rc.SetToken(<span class="typename">string</span>(s_token))        <span class="comment">// 为新登录用户设置 token</span></span><br><span class="line">        s.AddUser(rc)                       <span class="comment">// 加入在线用户列表</span></span><br><span class="line">        rc.DealWithRequests(s.db)           <span class="comment">// 处理用户请求</span></span><br><span class="line">        rc.Logout()                         <span class="comment">// 登出用户</span></span><br><span class="line">        s.RemoveUser(rc)                    <span class="comment">// 从在线用户列表移除该用户</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> mode == <span class="number">1</span> &amp;&amp; mainT.SetBuflen(conf.BUFLEN) &amp;&amp; rc.AddTransmit(mainT) &#123;</span><br><span class="line">        rc.DealWithTransmission(s.db, mainT)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> mode != <span class="number">2</span> &#123;</span><br><span class="line">        mainT.Destroy()</span><br><span class="line">        fmt.Println(<span class="string">"Remote client not valid"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>上面的代码中，10 行以前均为服务器生成 token 并发送 token。之后，服务器生成了一个 <code>transmitter</code> 来交给 <code>Login</code> 函数验证该连接合法性。<code>Login</code> 函数会返回一个指向用户的指针，以及一个 int 类型的 <code>code</code>，<code>code</code> 说明了验证的结果：<ul>
<li><code>code</code> 为 0：用户登陆成功</li>
<li><code>code</code> 为 1：用户已经登陆，当前连接是用于传输长数据流的连接</li>
<li><code>code</code> 为 2：用户已经登录，当前连接是用于被动监听广播的连接</li>
<li><code>code</code> 为-1：用户因为某种原因不合法（如密码不匹配，token不一致，数据库出错等）</li>
</ul>
</li>
<li><code>DealWithRequests()</code> 函数在之前已经介绍过一次，用来代理用户处理请求。该函数内部是一个 <code>for</code> 循环，不断监听用户发送的命令，当用户选择退出时才会跳出循环。</li>
<li><code>Login</code> 函数完成了 <code>Communicate</code> 函数验证连接是否合法的任务，它的实现会比较复杂，主要难度在对各种异常的容错上。</li>
<li>将用户添加到在线列表和从在线列表中删除用户的函数非常简单，代码如下，不再解释：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (s *Server) AddUser(u cs.User) &#123;</span><br><span class="line">    s.loginUserList = cs.AppendUser(s.loginUserList, u)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> (s *Server) RemoveUser(u cs.User) <span class="typename">bool</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i, uc := <span class="keyword">range</span> s.loginUserList &#123;</span><br><span class="line">        <span class="keyword">if</span> uc == u &#123;</span><br><span class="line">            s.loginUserList = <span class="built_in">append</span>(s.loginUserList[:i], s.loginUserList[i+<span class="number">1</span>:]...)</span><br><span class="line">            <span class="keyword">return</span> <span class="constant">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="constant">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="校验用户身份"><a href="#校验用户身份" class="headerlink" title="校验用户身份"></a>校验用户身份</h2><ul>
<li>我们还剩下最后一部分逻辑没有实现，即对用户登录身份的验证。</li>
<li><code>Login</code> 函数非常复杂，因为它需要处理用户的任何不合法行为，以及对用户的登录模式做出判断。用中文将 <code>Login</code> 的函数流程表达如下：<ol>
<li>服务器按照协议接收用户发送的用户名和密文的头部，共 24 字节，分别对应明文长度、包长度和用户名明文长度</li>
<li>服务器解析出包长度，并接收到完整的用户名+密码包，若接收时中断则退出</li>
<li>服务器解析出用户名和密码，若无法解析则退出</li>
<li>服务器检查已登录用户列表，是否存在该用户名，存在则转入活动连接判断模式，否则转 7 继续进行登录认证</li>
<li>服务器发现用户已登录，则认为该连接用来传输长数据流，或用来做被动监听</li>
<li>服务器对比解析出的密码和登录用户的 token 做比对，如果相同，则认为合法，否则退出。若相同，则观察该用户是否已具有 <code>info</code> 连接（即被动监听连接），若已存在 <code>info</code> 则认为该连接是长数据流传输，返回用户指针和模式 1；否则将该连接设置为用户的 <code>info</code> 并返回用户指针和模式 2</li>
<li>若第 4 步服务器检查登录用户列表并未发现该用户，则认为该用户未登录，此时在数据库中查找该用户，查找不到则退出</li>
<li>比对查找到的用户密码和用户传输的密码是否相同，不同则退出</li>
<li>用户密码相同，则统计用户已使用的云存储空间，并将已使用的空间设置到用户结构中</li>
<li>返回用户指针和 0，表示用户登录成功</li>
</ol>
</li>
<li><code>Login</code> 实现代码如下，大量篇幅用于 <code>if</code> 和 <code>err</code> 的处理上：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> (s *Server) Login(t trans.Transmitable) (cs.User, <span class="typename">int</span>) &#123;</span><br><span class="line">    <span class="comment">// mode : failed=-1, new=0, transmission=1</span></span><br><span class="line">    chRate := time.Tick(<span class="number">1e3</span>)</span><br><span class="line">    <span class="keyword">var</span> recvL <span class="typename">int64</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    recvL, err = t.RecvUntil(<span class="typename">int64</span>(<span class="number">24</span>), recvL, chRate)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"1 error:"</span>, err.Error())</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span>, -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    srcLength := auth.BytesToInt64(t.GetBuf()[:<span class="number">8</span>])</span><br><span class="line">    encLength := auth.BytesToInt64(t.GetBuf()[<span class="number">8</span>:<span class="number">16</span>])</span><br><span class="line">    nmLength := auth.BytesToInt64(t.GetBuf()[<span class="number">16</span>:<span class="number">24</span>])</span><br><span class="line">    recvL, err = t.RecvUntil(encLength, recvL, chRate)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"2 error:"</span>, err.Error())</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span>, -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> nameApass []<span class="typename">byte</span></span><br><span class="line">    nameApass, err = auth.AesDecode(t.GetBuf()[<span class="number">24</span>:<span class="number">24</span>+encLength], srcLength, t.GetBlock())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"decode error:"</span>, err.Error())</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span>, -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="typename">string</span>(nameApass[:nmLength]), <span class="typename">string</span>(nameApass[nmLength:]))</span><br><span class="line"></span><br><span class="line">    pc := cs.UserIndexByName(s.loginUserList, <span class="typename">string</span>(nameApass[:nmLength]))</span><br><span class="line">    <span class="comment">// 该连接由已登陆用户建立</span></span><br><span class="line">    <span class="keyword">if</span> pc != <span class="constant">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"userfined, "</span>, pc.GetUsername())</span><br><span class="line">        fmt.Println(<span class="string">"pc token is "</span>, pc.GetToken())</span><br><span class="line">        <span class="keyword">if</span> pc.GetToken() != <span class="typename">string</span>(nameApass[nmLength:]) &#123;</span><br><span class="line">            fmt.Println(<span class="string">"token verify error! not valid!"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="constant">nil</span>, -<span class="number">1</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// background message receiver</span></span><br><span class="line">            <span class="keyword">if</span> pc.GetInfos() == <span class="constant">nil</span> &#123;</span><br><span class="line">                pc.SetInfos(t)</span><br><span class="line">                <span class="keyword">return</span> pc, <span class="number">2</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// transmission</span></span><br><span class="line">                <span class="keyword">return</span> pc, <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该连接来自新用户</span></span><br><span class="line">    username := <span class="typename">string</span>(nameApass[:nmLength])</span><br><span class="line">    row := s.db.QueryRow(fmt.Sprintf(<span class="string">"SELECT * FROM cuser where username='%s'"</span>, username))</span><br><span class="line">    <span class="keyword">if</span> row == <span class="constant">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span>, -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> uid <span class="typename">int</span></span><br><span class="line">    <span class="keyword">var</span> susername <span class="typename">string</span></span><br><span class="line">    <span class="keyword">var</span> spassword <span class="typename">string</span></span><br><span class="line">    <span class="keyword">var</span> screated <span class="typename">string</span></span><br><span class="line"></span><br><span class="line">    err = row.Scan(&amp;uid, &amp;susername, &amp;spassword, &amp;screated)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> || spassword != strings.ToUpper(<span class="typename">string</span>(nameApass[nmLength:])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span>, -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    rc := cs.NewCUser(<span class="typename">string</span>(nameApass[:nmLength]), <span class="typename">int64</span>(uid), <span class="string">"/"</span>)</span><br><span class="line">    <span class="keyword">if</span> rc == <span class="constant">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span>, -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    rc.SetListener(t)</span><br><span class="line">    <span class="comment">// 统计用户已使用的云存储空间</span></span><br><span class="line">    rows, err := s.db.Query(fmt.Sprintf(<span class="string">"SELECT cfileid FROM ufile where ownerid=%d"</span>, uid))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="constant">nil</span>, -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> rows.Close()</span><br><span class="line">    <span class="keyword">var</span> cid, size <span class="typename">int</span></span><br><span class="line">    <span class="keyword">var</span> totalSize <span class="typename">int64</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">        err = rows.Scan(&amp;cid)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> || cid &lt; <span class="number">0</span>&#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        row = s.db.QueryRow(fmt.Sprintf(<span class="string">"select size from cfile where uid=%d"</span>, cid))</span><br><span class="line">        <span class="keyword">if</span> row == <span class="constant">nil</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        err = row.Scan(&amp;size)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="constant">nil</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        totalSize += <span class="typename">int64</span>(size)</span><br><span class="line">    &#125;</span><br><span class="line">    rc.SetUsed(<span class="typename">int64</span>(totalSize))</span><br><span class="line">    <span class="keyword">return</span> rc, <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>上面的代码基本遵循中文描述的过程，细节方面实现可能有顺序偏差，但大体一致。注意 <code>Login</code> 中对数据库查询出现错误的不同处理，在不影响用户正常行为逻辑的情况下，无所谓的错误可以用 <code>continue</code> 跳过。服务器会按一定周期检查有无遗失的文件记录。</li>
</ul>
<hr>
<p>专栏目录：<a href="http://blog.forec.cn/columns/zenith-cloud.html" target="_blank" rel="external">顶点云（应用）设计与实现</a><br>此专栏的上一篇文章：<a href="http://blog.forec.cn/2016/11/19/zenith-cloud-5/" target="_blank" rel="external">顶点云（应用）传输、认证单元测试</a><br>此专栏的下一篇文章：<a href="http://blog.forec.cn/2016/12/03/zenith-cloud-7/" target="_blank" rel="external">顶点云（应用）用户代理</a>   </p>
<p>原创作品，允许转载，转载时无需告知，但请务必以超链接形式标明文章<a href="http://blog.forec.cn/2016/11/23/zenith-cloud-6/" target="_blank" rel="external">原始出处</a>(<a href="http://blog.forec.cn/2016/11/23/zenith-cloud-6/" target="_blank" rel="external">http://blog.forec.cn/2016/11/23/zenith-cloud-6/</a>) 、作者信息（<a href="http://forec.cn/" target="_blank" rel="external">Forec</a>）和本声明。</p>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://forec.github.io/2016/11/23/zenith-cloud-6/" data-id="cj2j5vuub0014msew7q5ys6uf" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="uyan_frame"></div>

    
    </section>

                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/Forec" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus-circle" href="https://plus.google.com/u/0/103559279723380829001" target="_blank">
                        <i class="icon fa fa-google-plus-circle"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="https://www.facebook.com/MrForec" target="_blank">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="https://twitter.com/MrForec" target="_blank">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/atom.xml" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="mail-forward" href="mailto:forec@bupt.edu.cn" target="_blank">
                        <i class="icon fa fa-mail-forward"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2016/11/23/os-concepts-3/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            操作系统（三）：CPU 调度
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2016/11/22/os-concepts-2/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">操作系统（二）：进程与线程</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/21/AlligatorEggs/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/alligator/title.png)" alt="从鳄鱼蛋看 λ 演算" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Code/">Code</a></p>
                            <p class="item-title"><a href="/2017/03/21/AlligatorEggs/" class="title">从鳄鱼蛋看 λ 演算</a></p>
                            <p class="item-date"><time datetime="2017-03-21T15:42:42.000Z" itemprop="datePublished">2017-03-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/19/formal-languages-and-automata3/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/formal-languages-and-automata3.jpg)" alt="右线性语言" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/计算机理论基础/">计算机理论基础</a></p>
                            <p class="item-title"><a href="/2017/03/19/formal-languages-and-automata3/" class="title">右线性语言</a></p>
                            <p class="item-date"><time datetime="2017-03-19T15:09:53.000Z" itemprop="datePublished">2017-03-19</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/18/formal-languages-and-automata2/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/formal-languages-and-automata1.jpg)" alt="有限自动机" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/计算机理论基础/">计算机理论基础</a></p>
                            <p class="item-title"><a href="/2017/03/18/formal-languages-and-automata2/" class="title">有限自动机</a></p>
                            <p class="item-date"><time datetime="2017-03-18T13:41:32.000Z" itemprop="datePublished">2017-03-18</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/02/translation-adit-tum/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/translation-adit-tum.png)" alt="三种实用 Monad" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Code/">Code</a></p>
                            <p class="item-title"><a href="/2017/03/02/translation-adit-tum/" class="title">三种实用 Monad</a></p>
                            <p class="item-date"><time datetime="2017-03-02T10:24:20.000Z" itemprop="datePublished">2017-03-02</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/03/02/translation-adit-faamip/" class="thumbnail">
    
    
        <span style="background-image:url(http://7xktmz.com1.z0.glb.clouddn.com/translation-adit-faamip.png)" alt="图解 Functor, Applicative 和 Monad" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Code/">Code</a></p>
                            <p class="item-title"><a href="/2017/03/02/translation-adit-faamip/" class="title">图解 Functor, Applicative 和 Monad</a></p>
                            <p class="item-date"><time datetime="2017-03-02T06:07:40.000Z" itemprop="datePublished">2017-03-02</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Code/">Code</a><span class="category-list-count">33</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Configuration/">Configuration</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Language/">Language</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机理论基础/">计算机理论基础</a><span class="category-list-count">26</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Access/" style="font-size: 10px;">Access</a> <a href="/tags/Algorithms/" style="font-size: 20px;">Algorithms</a> <a href="/tags/CVM/" style="font-size: 10px;">CVM</a> <a href="/tags/Data-Structures/" style="font-size: 12.5px;">Data-Structures</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Emacs/" style="font-size: 10px;">Emacs</a> <a href="/tags/Golang/" style="font-size: 15.83px;">Golang</a> <a href="/tags/Hadoop/" style="font-size: 10.83px;">Hadoop</a> <a href="/tags/Haskell/" style="font-size: 15.83px;">Haskell</a> <a href="/tags/Mistakes/" style="font-size: 13.33px;">Mistakes</a> <a href="/tags/OS/" style="font-size: 19.17px;">OS</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Qt/" style="font-size: 10px;">Qt</a> <a href="/tags/Raspberry/" style="font-size: 10px;">Raspberry</a> <a href="/tags/Safety/" style="font-size: 10px;">Safety</a> <a href="/tags/Spark/" style="font-size: 10px;">Spark</a> <a href="/tags/sicp/" style="font-size: 10.83px;">sicp</a> <a href="/tags/云存储/" style="font-size: 15px;">云存储</a> <a href="/tags/函数式编程/" style="font-size: 16.67px;">函数式编程</a> <a href="/tags/图分割/" style="font-size: 10.83px;">图分割</a> <a href="/tags/字符编码/" style="font-size: 10.83px;">字符编码</a> <a href="/tags/机器学习/" style="font-size: 18.33px;">机器学习</a> <a href="/tags/线程/" style="font-size: 17.5px;">线程</a> <a href="/tags/自动机/" style="font-size: 11.67px;">自动机</a> <a href="/tags/计组与体系结构/" style="font-size: 14.17px;">计组与体系结构</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="mailto:forec@bupt.edu.cn">联系 Forec</a>
                    </li>
                
                    <li>
                        <a href="http://forec.cn">Forec 的官方网站</a>
                    </li>
                
                    <li>
                        <a href="https://fallenwood.github.io">Fallenwood 的博客</a>
                    </li>
                
                    <li>
                        <a href="https://github.com/Forec">Forec 在 GitHub</a>
                    </li>
                
                    <li>
                        <a href="https://www.codewars.com/users/Forec">Forec 在 CodeWars</a>
                    </li>
                
                    <li>
                        <a href="https://leetcode.com/forec/">Forec 在 LeetCode</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>京ICP备16060806号-1 &copy; 2017 Forec</p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2133293# enter youyan uid here"></script>



    
        <script src="/libs/lightgallery/js/lightgallery.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js" type="text/javascript"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js" type="text/javascript"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js" type="text/javascript"></script>

    </div>
</body>
</html>
